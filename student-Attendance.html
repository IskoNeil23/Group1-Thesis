<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Student Attendance Record - City College of Angeles City</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .sidebar {
            height: 100%;
            width: 250px;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: darkgreen;
            overflow-x: hidden;
            padding-top: 60px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar img.navlog {
            width: 80px;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }
        
        .sidebar h1 {
            color: white;
            text-align: center;
            font-size: 35px;
            padding: 0 15px;
            margin-bottom: 30px;
        }
        
        .sidebar a {
            padding: 10px 15px;
            text-decoration: none;
            color: white;
            display: block;
            transition: 0.3s;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background-color: wheat;
            color: black;
            font-weight: bold;
        }
        
        .topnav {
            height: 70px;
            background-color: darkgreen;
            position: fixed;
            top: 0;
            left: 250px;
            color: white;
            right: 0;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: white;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .nav-left img {
            height: 50px;
            margin-right: 15px;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        
        .main {
            margin-left: 250px;
            padding: 90px 20px 20px;
        }
        
        .attendance-header {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .attendance-header h1 {
            color: darkgreen;
            margin-top: 0;
        }
        
        .attendance-filter {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .attendance-records {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .attendance-records h2 {
            color: darkgreen;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .subject-attendance {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .subject-attendance h3 {
            color: darkgreen;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .subject-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            margin: 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .attendance-table th, .attendance-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .attendance-table th {
            background-color: #f2f2f2;
        }
        
        .attendance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .status-present {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .status-absent {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        
        .status-late {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        
        .status-excused {
            background-color: #d1ecf1;
            color: #0c5460;
            font-weight: bold;
        }
        
        .summary-box {
            display: flex;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
            padding: 10px;
            border-radius: 4px;
        }
        
        .summary-item.present {
            background-color: #d4edda;
            color: #155724;
        }
        
        .summary-item.absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .summary-item.late {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .summary-item.excused {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .summary-item.status {
            background-color: #e2e3e5;
            color: #383d41;
            font-weight: bold;
        }
        
        .summary-item.status.fa {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .summary-item.status.good {
            background-color: #d4edda;
            color: #155724;
        }
        
        .print-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .print-btn:hover {
            background-color: #388E3C;
        }
        
        .no-records {
            padding: 50px 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .legend {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .legend-item {
            display: inline-block;
            margin-right: 15px;
        }
        
        @media screen and (max-width: 768px) {
            .sidebar {
                width: 0;
                padding-top: 15px;
            }
            
            .main, .topnav {
                margin-left: 0;
                left: 0;
            }
            
            .attendance-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .attendance-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        @media print {
            .sidebar, .topnav, .print-btn, .attendance-filter select, .logout-btn {
                display: none;
            }
            
            .main {
                margin-left: 0;
                padding-top: 20px;
            }
            
            .attendance-table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img class="navlog" src="cca-logo.png" alt="CCA Logo">
        <h1>City College of Angeles</h1>
        <a href="student-dashboard.html">Dashboard</a>
        <a href="student-schedule.html">Schedule</a>
        <a href="student-attendance.html" class="active">Attendance</a>
        <a>Grades</a>
        <a href="student-approval-sheet.html">Approval Letter</a>
    </div>
    
    <div class="topnav">
        <div class="nav-left">
            <img src="cca-logo.png" alt="CCA Logo">
            <h3>Student Portal - Attendance Records</h3>
        </div>
        <button class="logout-btn" onclick="logout()">Log Out</button>
    </div>
    
    <div class="main">
        <div class="attendance-header">
            <h1>My Attendance Records</h1>
            <p>Student: <span id="studentName">Loading...</span> (<span id="studentNumber">Loading...</span>)</p>
            <p>Program: <span id="studentProgram">Loading...</span></p>
            
            <div class="attendance-filter">
                <div class="filter-group">
                    <label for="schoolYear">School Year:</label>
                    <select id="schoolYear" onchange="filterAttendance()">
                        <option value="2024-2025" selected>2024-2025</option>
                        <option value="2025-2026">2025-2026</option>
                        <option value="2026-2027">2026-2027</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="semester">Semester:</label>
                    <select id="semester" onchange="filterAttendance()">
                        <option value="1st Semester">1st Semester</option>
                        <option value="2nd Semester">2nd Semester</option>
                        <option value="Summer">Summer</option>
                    </select>
                </div>
                
                <button class="print-btn" onclick="window.print()">Print Records</button>
            </div>
        </div>
        
        <div class="attendance-records">
            <h2>Attendance Summary</h2>
            <div id="attendanceInfo">
                <p><strong>Year Level:</strong> <span id="yearLevel">Loading...</span></p>
                <p><strong>Section:</strong> <span id="section">Loading...</span></p>
                <p><strong>Overall Status:</strong> <span id="overallStatus">Loading...</span></p>
            </div>
            
            <div id="subjectAttendanceContainer">
                <!-- Subject attendance records will be inserted here -->
                <div class="no-records" id="noRecordsMessage">
                    No attendance records found for the selected semester.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Function to format time in 12-hour format
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const time = new Date();
            time.setHours(parseInt(hours, 10));
            time.setMinutes(parseInt(minutes, 10));
            
            return time.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
        }
        
        // Function to get ordinal suffix for numbers
        function getOrdinal(n) {
            const number = parseInt(n);
            if (isNaN(number)) return n;
            
            const j = number % 10;
            const k = number % 100;
            
            if (j === 1 && k !== 11) {
                return number + "st";
            }
            if (j === 2 && k !== 12) {
                return number + "nd";
            }
            if (j === 3 && k !== 13) {
                return number + "rd";
            }
            return number + "th";
        }
        
        // Function to check login status
        function checkLogin() {
            const loggedInStudent = JSON.parse(sessionStorage.getItem('loggedInStudent'));
            
            if (!loggedInStudent) {
                // Redirect to login page if not logged in
                window.location.href = 'student-login.html';
                return null;
            }
            
            // Try to get additional student information from enrolled students database
            const enrolledStudents = JSON.parse(localStorage.getItem('enrolledStudents')) || [];
            const fullStudentInfo = enrolledStudents.find(student => 
                student.studentNumber === loggedInStudent.studentNumber
            ) || loggedInStudent;
            
            return fullStudentInfo;
        }
        
        // Function to display student info
        function displayStudentInfo(student) {
            document.getElementById('studentName').textContent = `${student.firstName} ${student.lastName}`;
            document.getElementById('studentNumber').textContent = student.studentNumber;
            document.getElementById('studentProgram').textContent = `${student.course} (${student.institute})`;
            document.getElementById('yearLevel').textContent = `${getOrdinal(student.yearLevel)} Year`;
            document.getElementById('section').textContent = student.section;
        }
        
        // Function to calculate attendance summary
        function calculateAttendanceSummary(studentAttendance) {
            if (!studentAttendance || Object.keys(studentAttendance).length === 0) {
                return { 
                    status: 'good', 
                    lateCount: 0, 
                    absentCount: 0, 
                    presentCount: 0,
                    excusedCount: 0
                };
            }
            
            let lateCount = 0;
            let absentCount = 0;
            let presentCount = 0;
            let excusedCount = 0;
            
            // Count statuses
            Object.values(studentAttendance).forEach(status => {
                if (status === 'late') lateCount++;
                else if (status === 'absent') absentCount++;
                else if (status === 'present') presentCount++;
                else if (status === 'excused') excusedCount++;
            });
            
            // Convert lates to absents (3 lates = 1 absent)
            const additionalAbsents = Math.floor(lateCount / 3);
            const totalAbsents = absentCount + additionalAbsents;
            
            // Determine status (4 or more absents = FA)
            const status = totalAbsents >= 4 ? 'fa' : 'good';
            
            return {
                status,
                lateCount,
                absentCount: totalAbsents,
                presentCount,
                excusedCount,
                originalAbsentCount: absentCount
            };
        }
        
        // Function to get student's schedule for filtering subjects
        function getStudentSchedule(student, schoolYear, semester) {
            // Get all instructor schedules
            const allSchedules = JSON.parse(localStorage.getItem('instructorSchedules')) || [];
            
            // Filter schedules for this student
            return allSchedules.filter(schedule => 
                schedule.institute === student.institute &&
                schedule.course === student.course &&
                schedule.yearLevel === student.yearLevel &&
                schedule.section === student.section &&
                schedule.schoolYear === schoolYear &&
                schedule.semester === semester
            );
        }
        
        // Function to get attendance data for a specific class
        function getAttendanceData(institute, course, yearLevel, section, subjectCode) {
            const attendanceKey = `attendance_${institute}_${course}_${yearLevel}_${section}_${subjectCode}`;
            return JSON.parse(localStorage.getItem(attendanceKey)) || {};
        }
        
        // Function to filter and display attendance records
        function filterAttendance() {
            const student = checkLogin();
            if (!student) return;
            
            // Get filter values
            const selectedSchoolYear = document.getElementById('schoolYear').value;
            const selectedSemester = document.getElementById('semester').value;
            
            // Get student's schedule for the selected filters
            const studentSchedule = getStudentSchedule(student, selectedSchoolYear, selectedSemester);
            
            // Clear previous attendance records
            const container = document.getElementById('subjectAttendanceContainer');
            container.innerHTML = '';
            
            // If no schedule found
            if (studentSchedule.length === 0) {
                container.innerHTML = `
                    <div class="no-records">
                        No classes found for the selected semester.
                    </div>
                `;
                document.getElementById('overallStatus').textContent = 'N/A';
                return;
            }
            
            // Sort subjects by subject code
            studentSchedule.sort((a, b) => a.subjectCode.localeCompare(b.subjectCode));
            
            // Track overall attendance status
            let hasFailingAttendance = false;
            
            // Display attendance for each subject
            studentSchedule.forEach(subject => {
                // Get attendance data for this subject
                const attendanceData = getAttendanceData(
                    subject.institute, 
                    subject.course, 
                    subject.yearLevel, 
                    subject.section,
                    subject.subjectCode
                );
                
                // Get student's attendance record
                const studentAttendance = attendanceData[student.studentNumber] || {};
                
                // Calculate attendance summary
                const summary = calculateAttendanceSummary(studentAttendance);
                
                // Check if attendance status is failing
                if (summary.status === 'fa') {
                    hasFailingAttendance = true;
                }
                
                // Create subject attendance container
                const subjectElement = document.createElement('div');
                subjectElement.className = 'subject-attendance';
                
                // Format time in 12-hour format
                const formattedStartTime = formatTime(subject.startTime);
                const formattedEndTime = formatTime(subject.endTime);
                
                // Create subject header
                const subjectHeader = document.createElement('h3');
                subjectHeader.innerHTML = `
                    <span>${subject.subjectCode}: ${subject.subjectTitle}</span>
                    <button class="print-btn" onclick="printSubjectAttendance('${subject.institute}', '${subject.course}', '${subject.yearLevel}', '${subject.section}', '${subject.subjectCode}')">Print</button>
                `;
                subjectElement.appendChild(subjectHeader);
                
                // Create subject info
                const subjectInfo = document.createElement('div');
                subjectInfo.className = 'subject-info';
                subjectInfo.innerHTML = `
                    <p class="info-item"><span class="info-label">Schedule:</span> ${subject.dayOfWeek}, ${formattedStartTime} - ${formattedEndTime}</p>
                    <p class="info-item"><span class="info-label">Room:</span> ${subject.roomNumber}</p>
                    <p class="info-item"><span class="info-label">Type:</span> ${subject.classType}</p>
                    <p class="info-item"><span class="info-label">Units:</span> ${subject.units}</p>
                    <p class="info-item"><span class="info-label">Instructor:</span> ${subject.instructorName}</p>
                `;
                subjectElement.appendChild(subjectInfo);
                
                // Create attendance table
                const tableContainer = document.createElement('div');
                tableContainer.style.overflowX = 'auto';
                
                const table = document.createElement('table');
                table.className = 'attendance-table';
                
                // Create table header
                const thead = document.createElement('thead');
                let headerRow = '<tr>';
                headerRow += '<th>Week</th>';
                headerRow += '<th>Status</th>';
                headerRow += '</tr>';
                thead.innerHTML = headerRow;
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                
                // Add a row for each week
                let hasAnyAttendance = false;
                for (let week = 1; week <= 18; week++) {
                    const status = studentAttendance[week] || 'null';
                    
                    // Skip if no attendance was recorded
                    if (status === 'null') continue;
                    
                    hasAnyAttendance = true;
                    
                    // Create row
                    const row = document.createElement('tr');
                    
                    // Week column
                    const weekCell = document.createElement('td');
                    weekCell.textContent = `Week ${week}`;
                    row.appendChild(weekCell);
                    
                    // Status column
                    const statusCell = document.createElement('td');
                    statusCell.className = `status-${status}`;
                    
                    switch (status) {
                        case 'present':
                            statusCell.textContent = 'Present';
                            break;
                        case 'absent':
                            statusCell.textContent = 'Absent';
                            break;
                        case 'late':
                            statusCell.textContent = 'Late';
                            break;
                        case 'excused':
                            statusCell.textContent = 'Excused';
                            break;
                        default:
                            statusCell.textContent = '-';
                            break;
                    }
                    
                    row.appendChild(statusCell);
                    tbody.appendChild(row);
                }
                
                // If no attendance records found
                if (!hasAnyAttendance) {
                    const noRecordsRow = document.createElement('tr');
                    const noRecordsCell = document.createElement('td');
                    noRecordsCell.colSpan = 2;
                    noRecordsCell.textContent = 'No attendance records have been submitted yet.';
                    noRecordsCell.style.textAlign = 'center';
                    noRecordsCell.style.padding = '20px';
                    noRecordsRow.appendChild(noRecordsCell);
                    tbody.appendChild(noRecordsRow);
                }
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                subjectElement.appendChild(tableContainer);
                
                // Create attendance summary
                const summaryBox = document.createElement('div');
                summaryBox.className = 'summary-box';
                
                summaryBox.innerHTML = `
                    <div class="summary-item present">
                        <div class="summary-value">${summary.presentCount}</div>
                        <div class="summary-label">Present</div>
                    </div>
                    <div class="summary-item late">
                        <div class="summary-value">${summary.lateCount}</div>
                        <div class="summary-label">Late</div>
                    </div>
                    <div class="summary-item absent">
                        <div class="summary-value">${summary.originalAbsentCount}</div>
                        <div class="summary-label">Absent</div>
                    </div>
                    <div class="summary-item excused">
                        <div class="summary-value">${summary.excusedCount}</div>
                        <div class="summary-label">Excused</div>
                    </div>
                    <div class="summary-item status ${summary.status}">
                        <div class="summary-value">${summary.status.toUpperCase()}</div>
                        <div class="summary-label">Status</div>
                    </div>
                `;
                
                subjectElement.appendChild(summaryBox);
                
                // Add legend
                const legend = document.createElement('div');
                legend.className = 'legend';
                legend.innerHTML = `
                    <div class="legend-title">Notes:</div>
                    <div class="legend-item">• 3 Lates = 1 Absent</div>
                    <div class="legend-item">• 4+ Absents = FA (Failure due to Absence)</div>
                    <div class="legend-item">• Current Total Absents: ${summary.absentCount} (including ${Math.floor(summary.lateCount / 3)} from lates)</div>
                `;
                
                subjectElement.appendChild(legend);
                
                // Add to container
                container.appendChild(subjectElement);
            });
            
            // Update overall status
            document.getElementById('overallStatus').textContent = hasFailingAttendance ? 
                'At Risk - You have failing attendance in one or more subjects' : 
                'Good Standing';
            document.getElementById('overallStatus').style.color = hasFailingAttendance ? '#721c24' : '#155724';
        }
        
        // Function to print attendance for a specific subject
        function printSubjectAttendance(institute, course, yearLevel, section, subjectCode) {
            const student = checkLogin();
            if (!student) return;
            
            // Get attendance data
            const attendanceData = getAttendanceData(institute, course, yearLevel, section, subjectCode);
            const studentAttendance = attendanceData[student.studentNumber] || {};
            
            // Get subject details
            const allSchedules = JSON.parse(localStorage.getItem('instructorSchedules')) || [];
            const subject = allSchedules.find(s => 
                s.institute === institute &&
                s.course === course &&
                s.yearLevel === yearLevel &&
                s.section === section &&
                s.subjectCode === subjectCode
            );
            
            if (!subject) {
                alert('Subject information not found.');
                return;
            }
            
            // Calculate attendance summary
            const summary = calculateAttendanceSummary(studentAttendance);
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            // Format time in 12-hour format
            const formatTime = (timeString) => {
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours);
                const amPm = hour >= 12 ? 'PM' : 'AM';
                const formattedHour = hour % 12 === 0 ? 12 : hour % 12;
                return `${formattedHour}:${minutes} ${amPm}`;
            };
            
            // Get year level text
            const yearLevelText = {
                '1': '1st Year',
                '2': '2nd Year',
                '3': '3rd Year',
                '4': '4th Year'
            }[yearLevel] || yearLevel;
            
            // Create print content
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Attendance Record - ${subject.subjectCode}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .logo {
                            max-width: 100px;
                            margin-bottom: 10px;
                        }
                        .school-name {
                            font-size: 18px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .student-name {
                            font-size: 16px;
                            margin-bottom: 5px;
                        }
                        .subject-title {
                            font-size: 14px;
                            margin-bottom: 15px;
                        }
                        .details {
                            display: flex;
                            flex-wrap: wrap;
                            margin-bottom: 20px;
                            border: 1px solid #ddd;
                            padding: 10px;
                            background-color: #f9f9f9;
                        }
                        .detail {
                            flex: 1 0 200px;
                            margin-bottom: 5px;
                        }
                        .detail-label {
                            font-weight: bold;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: center;
                        }
                        th {
                            background-color: #f2f2f2;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .status-present {
                            background-color: #d4edda;
                            color: #155724;
                            font-weight: bold;
                        }
                        .status-absent {
                            background-color: #f8d7da;
                            color: #721c24;
                            font-weight: bold;
                        }
                        .status-late {
                            background-color: #fff3cd;
                            color: #856404;
                            font-weight: bold;
                        }
                        .status-excused {
                            background-color: #d1ecf1;
                            color: #0c5460;
                            font-weight: bold;
                        }
                        .summary {
                            display: flex;
                            flex-wrap: wrap;
                            justify-content: space-between;
                            margin-bottom: 20px;
                        }
                        .summary-item {
                            text-align: center;
                            flex: 1;
                            padding: 10px;
                            border-radius: 4px;
                            margin: 0 5px;
                        }
                        .summary-item.present {
                            background-color: #d4edda;
                            color: #155724;
                        }
                        .summary-item.absent {
                            background-color: #f8d7da;
                            color: #721c24;
                        }
                        .summary-item.late {
                            background-color: #fff3cd;
                            color: #856404;
                        }
                        .summary-item.excused {
                            background-color: #d1ecf1;
                            color: #0c5460;
                        }
                        .summary-item.status {
                            background-color: #e2e3e5;
                            color: #383d41;
                        }
                        .summary-item.status.fa {
                            background-color: #f8d7da;
                            color: #721c24;
                        }
                        .summary-item.status.good {
                            background-color: #d4edda;
                            color: #155724;
                        }
                        .signature {
                            margin-top: 50px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .signature-line {
                            width: 200px;
                            border-top: 1px solid #000;
                            margin-top: 30px;
                            text-align: center;
                        }
                        .notes {
                            margin-top: 20px;
                            font-size: 11px;
                            font-style: italic;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 10px;
                            color: #777;
                        }
                        @media print {
                            body {
                                margin: 0.5cm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img class="logo" src="cca-logo.png" alt="CCA Logo">
                        <div class="school-name">City College of Angeles City</div>
                        <div>Student Attendance Record</div>
                    </div>
                    
                    <div class="student-name">
                        Student: <strong>${student.firstName} ${student.lastName}</strong> (${student.studentNumber})
                    </div>
                    <div class="subject-title">
                        Subject: <strong>${subject.subjectCode}: ${subject.subjectTitle}</strong>
                    </div>
                    
                    <div class="details">
                        <div class="detail">
                            <span class="detail-label">Program:</span> ${subject.course}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Year & Section:</span> ${yearLevelText} - ${subject.section}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Institute:</span> ${subject.institute}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Instructor:</span> ${subject.instructorName}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Schedule:</span> ${subject.dayOfWeek}, ${formatTime(subject.startTime)} - ${formatTime(subject.endTime)}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Room:</span> ${subject.roomNumber}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Semester:</span> ${subject.semester}, ${subject.schoolYear}
                        </div>
                        <div class="detail">
                            <span class="detail-label">Units:</span> ${subject.units}
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `);
            
            // Add attendance records
            let hasAnyAttendance = false;
            for (let week = 1; week <= 18; week++) {
                const status = studentAttendance[week] || 'null';
                
                // Skip if no attendance was recorded
                if (status === 'null') continue;
                
                hasAnyAttendance = true;
                
                // Status text mapping
                const statusText = {
                    'present': 'Present',
                    'absent': 'Absent',
                    'late': 'Late',
                    'excused': 'Excused'
                }[status] || '-';
                
                printWindow.document.write(`
                    <tr>
                        <td>Week ${week}</td>
                        <td class="status-${status}">${statusText}</td>
                    </tr>
                `);
            }
            
            // If no attendance records found
            if (!hasAnyAttendance) {
                printWindow.document.write(`
                    <tr>
                        <td colspan="2" style="text-align: center; padding: 20px;">
                            No attendance records have been submitted yet.
                        </td>
                    </tr>
                `);
            }
            
            // Complete the table and add summary
            printWindow.document.write(`
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <div class="summary-item present">
                            <div style="font-size: 18px; font-weight: bold;">${summary.presentCount}</div>
                            <div>Present</div>
                        </div>
                        <div class="summary-item late">
                            <div style="font-size: 18px; font-weight: bold;">${summary.lateCount}</div>
                            <div>Late</div>
                        </div>
                        <div class="summary-item absent">
                            <div style="font-size: 18px; font-weight: bold;">${summary.originalAbsentCount}</div>
                            <div>Absent</div>
                        </div>
                        <div class="summary-item excused">
                            <div style="font-size: 18px; font-weight: bold;">${summary.excusedCount}</div>
                            <div>Excused</div>
                        </div>
                        <div class="summary-item status ${summary.status}">
                            <div style="font-size: 18px; font-weight: bold;">${summary.status.toUpperCase()}</div>
                            <div>Status</div>
                        </div>
                    </div>
                    
                    <div class="notes">
                        <p><strong>Notes:</strong></p>
                        <ul>
                            <li>3 Lates = 1 Absent</li>
                            <li>4+ Absents = FA (Failure due to Absence)</li>
                            <li>Current Total Absents: ${summary.absentCount} (including ${Math.floor(summary.lateCount / 3)} from lates)</li>
                        </ul>
                    </div>
                    
                    <div class="signature">
                        <div>
                            <div class="signature-line">Student Signature</div>
                        </div>
                        <div>
                            <div class="signature-line">Instructor Signature</div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Printed on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                        <p>This is an official attendance record from the City College of Angeles City Student Portal.</p>
                    </div>
                </body>
                </html>
            `);
            
            // Focus and print
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        // Function to handle logout
        function logout() {
            sessionStorage.removeItem('loggedInStudent');
            window.location.href = 'student-login.html';
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            const student = checkLogin();
            if (student) {
                displayStudentInfo(student);
                filterAttendance();
            }
        });
    </script>
</body>
</html>